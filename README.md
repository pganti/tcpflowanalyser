# tcpflowAnalyser

tcpAnalyser analyses tcpdump as text files (generated by reading a binary tcpdump using tcpdump -r). Given a tcp flow, identified by ( source @ , source port# , dest @ , dest port# ), it groups packets into  clusters and determines wether a given packet was a duplicate or a filler of a previous ( or the same ) group. It then performs some statistics on the groups.

## Installation

Its written in perl so you need only Shell perl module for management of files which is also included here

## Usage

perl tcpAnalyser.pm localhost tcpDumpFile version destination source_port_number dest_port_number direction interval details delete 

------
* localhost = the host on which tcpdump was executed ( and not the one on which you are currently working )
* tcpDumpFile = the name of the tcpdump output file.
* version = "ad"||"al" for adam or alexei. Each one corresponds to a method to group packets. 
* destination = a remote host or "*"
* source_port_number = se
* dest_port_number = se
* direction = "in"||"out" for incoming or outgoing for localhost
* interval = a number, in microseconds, used to group packets 
* details = 1||0 , 0 by default. If 1, the program prints the packet details
* delete = 1||0 , 1 by default. If 1, the program deletes the files that it created for analysis. Each file contains the data included in the tcpdump output file but for the same flow, so it could be useful to keep these files for further analysis.


Typically tcpdump file comtains several different flows, so this script  program allows you to choose which flow you want to analyse. We assume that the source @ or name is the same = local host, and is the @ or name of the machine on which tcpdump was executed. You can then specify  the source port number, the destination @ and the destination port number. There is also a wildcard "*" that means "all of".

for example if you say

perl tcpAnalyser.pm 172.16.31.190 origin.txt ad 156.152.56.130 "*" 8080 in 10000 0 0

that means: analyse all the flows in the direction 156.152.56.130 port 8080  -> any port on 172.16.31.190

It will prompt you with all the flows and you can select the flows

1 flows analysed:
- from 156.152.56.130 port 8080 to 172.16.31.190 port 34293 

You'll also see files created in the directory that has the packets in a single direction



# Analysis of Single Flow

--------------------
For each flow that you specified, the program does the following:

 for each packet, it looks at its timestamp,

  if version = "ad" :   if the difference between this time and the timestamp of the previous packet is smaller than "interval", then the packet belongs to the current group, otherwise, it is the first packet of the next group.

Example:

         {  packet i1 , TSi1
         {  packet i2 , TSi2
GROUP i  {         .
         {         .
         {  packet ip , TSip

            packet k , TSk   => packet being read:  if TSk - TSip <= interval then put packet k in group i, otherwise packet k is the first
                                packet of group i+1 


  if version = "al" :   if the difference between this time and the timestamp of the first packet of the current group is smaller than "interval", then the packet belongs to the current group, otherwise it starts a new group. 

Example:

         {  packet i1 , TSi1
         {  packet i2 , TSi2
GROUP i  {         .
         {         .
         {  packet ip , TSip

            packet k , TSk   => packet being read:  if TSk - TSi1 <= interval then put packet k in group i, otherwise packet k is the first 
                                packet of group i+1

  once a packet has been placed in a group, the program verifies if the packet is new or is a duplicate of a previous packet ( of a previous group or the same group) or a filler of a previous group. 


          {  packet i1: 0    - 1000
GROUP i   {  packet i2: 1000 - 2000
          {  packet i3: 4000 - 5000
          {  packet i4: 3000 - 4000

          {  packeti+11: 1000 - 2000    => is a duplicate of packet i2, fo group i 
GROUP i+1 {  packeti+12: 2000 - 3000    => is a filler of group i

The program then performs some statistics on the groups and prints them with the following format:

Gi-     ST:TSi1    ET:TSi2   El:n1     GP:n2   P:n3    NP:n4    NRC:n5       NDB:n6       MDB:n7          F (fi)      D (di)   M ( optional ) 

* Gi is the group number
* ST is the start time of the group, that is the timestamp of the first packet of this group
* ET is the end time, that is ....
* El is the elapsed time between the first packet and the last one of this group. ( that is TSi2 - TSi1 ) 
* GP is the elapsed time between the start time of this group and the start time of the previous one.( that is TSi1 - TSi-11
* P is the total number of packets in the group
* NP is the number of new packets, that is non duplicate nor filler packets. 
* NRC is the new range covered, that is the highest sequence number ( this is necessarily a new packet ) minus the lowest sequence number (
  of a new packet ).
* NDB is the number of new data bytes in the group 
* MDB is the number of missing data bytes in the group, that is the ones that should have been observed but that did not
  note that MDB = NRC - NDB
* F is a sequence that indicates the number of fillers and the groups in which they should have been observed 
    for example, F 1 2 10 2 means that the current group contains four fillers that should have appeared in groups 1, 2, 10 and 2
* D is the same but for duplicate
* the flag M indicates if a misordering has occured in the group 

Example: the statistics for group i would be:

Gi-   ST:TSi1   ET:TSi2     El:TSi2-TSi1     GP:TSi1-TSi-11  P:4  NP:4  NRC:5000  NDB:4000  MDB:1000  F   D   M

and for group i+1:

Gi+1- ST:TSi+1  ET:TSi+12   EL:TSi+12-TSi+1  GP:TSi+1-TSi1   P:2  NP:0  NRC:0     NDB:0     MDB:0     F i D i 

If the user has chosen details = 1 then the program also prints the packet details, that is for each group it prints the new packets as they
were observed in the dump file ( that is with the same format ) and then the duplicate or fillers. 

Example:

group 0: 0 11:43:47.743470 1714077297:1714077357 |                     one new data packet for group 0
group 0:                                                               no dups of fillers for group 0 
group 1:                                                               no new data packets for group 1
group 1: 1 11:43:47.773242 0:60 PUREFILLERof0,|                        one filler of group 0 for group 1

remarks:
--------

* sometimes tcpdump does not translate the sequence number ( absolute ) of the first packet to a relative sequence number.
  Thus we sometimes have:
        packet1 176571321231:176571321232 
        packet2 0:1460
  or
        packet1 176571321231:176571321232
        packet2 1:1461

  In order for the program to work, I had to translate the sequence number myself. So when this occurs, the program will translate 
        the sequence numbers of packet1 into -1:0
  As a consequence in the second case the program will work with
        packet1 -1:0
        packet2  1:1461
                        and will write that there is one missing byte where it shouldn't. 

  This does not happen very often, as the first packet is often an S packet.

* The program only watches the data packets in the dump file, it does not care for acks, S , or F packets.
* It can work with overlaps, that is for example: 
     packeti  :  1000 - 2000
     packeti+1:  1500 - 1800         the progam will detect that packeti+1 is a duplicate of packeti

but fillers have to fit exactly the gap, or be smaller. Moreover a filler will remain a filler, that is even if the gap has been filled, 
another copy will be detected as a filler, not as a duplicate.
 Example:

          {  packet i1: 0    - 1000
GROUP i   {  packet i2: 1000 - 2000
          {  packet i3: 4000 - 5000
          {  packet i4: 3000 - 4000 

          {  packeti+11: 1000 - 2000    => is a duplicate of packet i2, for group i
GROUP i+1 {  packeti+12: 2000 - 3000    => is a filler of groupi


GROUP i+2 {  packeti+21: 1000 - 2000    => is a filler of groupi, not a duplicate of packeti+11 groupi+1. ( it is but the program does not 
                                                                                                                know
* if a group contains no new data bytes, then it contains no missing data bytes.

* How to choose the interval: 
  for version=ad:       the interval should be the transmission time Tx. Indeed, if the packet belongs to the same cwnd then the time between
                        two packets is the transmission time. Otherwise it is   RTT - n*Tx > Tx and the packet will start a new group. 

  for version=al:       the interval should be the RTT, more or less.

* a copy of the output can be found in the file named "output"

#TODO

 - the format of the output only allows for a few duplicates and fillers to be displayed ( 2 or 3 ). It is impossible to display more 
  ( if there are more to display ) and keep the date fit in one line. Suggestions ?
 - the interval is the same for every flow, which may not make much sense in high loss, but you can specify the flows that you want to analyse... 
